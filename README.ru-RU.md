[![en](https://img.shields.io/badge/lang-en-green.svg)](https://github.com/apostoldevel/module-PGFile/blob/master/README.md)

Postgres File
-
**PGFile** — модуль для [Apostol](https://github.com/apostoldevel/apostol) + [db-platform](https://github.com/apostoldevel/db-platform) — **Apostol CRM**[^crm].

Описание
-
**PGFile** синхронизирует файлы между PostgreSQL и локальной файловой системой. Подписывается на уведомления `LISTEN/NOTIFY` от модуля `file` платформы [db-platform](https://github.com/apostoldevel/db-platform) и записывает, обновляет или удаляет физические файлы на диске при каждом изменении записей в базе данных.

Модуль работает как долгоживущий **Helper** во вспомогательном процессе Апостол, используя общий цикл событий на основе `epoll` — без потоков, без блокирующего ввода-вывода.

> **PGFile** и **FileServer** — взаимодополняющие модули на основе общего базового класса `FileCommon`. PGFile наполняет файловую систему данными из базы; FileServer раздаёт эти файлы по HTTP.

Принцип работы
-
Таблица `db.file` имеет триггер `AFTER INSERT/UPDATE/DELETE` (`t_file_notify`), который отправляет уведомление `pg_notify('file', payload)` следующего вида:

```json
{"session": "...", "operation": "INSERT|UPDATE|DELETE", "id": "uuid", "type": "-|l|s", "name": "...", "path": "...", "hash": "..."}
```

PGFile:
1. Подписывается на канал уведомлений PostgreSQL `file` через `LISTEN file`.
2. При поступлении уведомления — считывает полную запись файла из базы данных через `api.get_file(id)`.
3. В зависимости от операции и типа файла — записывает, заменяет, загружает или удаляет файл.

Типы файлов
-
| Тип | Значение в БД | Действие PGFile |
|-----|--------------|-----------------|
| `-` | Обычный файл | Декодировать base64-содержимое из колонки `data` и записать на диск. |
| `l` | Символическая ссылка (URL) | Колонка `data` содержит HTTP/HTTPS URL; загрузить ресурс через встроенный HTTP-клиент или cURL и сохранить. |
| `s` | Хранилище (S3) | Удалить локальную копию с диска — S3 теперь является авторитетным хранилищем. |
| `d` | Директория | Не обрабатывается напрямую; директории создаются по мере необходимости при записи файлов. |

При операции **UPDATE**, если изменился путь или хэш содержимого, старый файл удаляется перед записью нового.

При операции **DELETE**, физический файл удаляется с диска без обращения к базе данных.

Загрузка в S3
-
Файлы можно загрузить в S3 из слоя базы данных с помощью `PutFileToS3(id, region, done, fail)`:

1. Читает содержимое и метаданные файла из `db.file`.
2. Читает конфигурацию S3 из реестра (`CONFIG\S3`: Region, Endpoint, AccessKey, SecretKey).
3. Формирует заголовок авторизации **AWS Signature Version 4** (HMAC-SHA256) полностью в PL/pgSQL.
4. Вызывает `http.fetch(...)` — **PGFetch** асинхронно отправляет `PUT`-запрос на S3.
5. По завершении `done`-callback обновляет запись `db.file` (как правило, устанавливает `type = 's'`, удаляя blob из колонки `data`).
6. Триггер `t_file_notify` срабатывает с `type = 's'` → PGFile получает уведомление и **удаляет локальную копию** (S3 становится хранилищем).

Если корневая директория называется `public`, заголовок `x-amz-acl: public-read` добавляется автоматически.

Функции обратного вызова
-
В записи `db.file` могут быть указаны колонки `done` и `fail` — полные имена PL/pgSQL-функций (`schema.function`), вызываемых после успешной операции с файлом или при ошибке соответственно.

Для **загрузки по URL** (тип `l`) callback вызывается после сохранения ресурса на локальный диск со следующей сигнатурой:

```sql
CREATE OR REPLACE FUNCTION schema.my_done (
  pId           uuid,    -- идентификатор файла из db.file
  pAbsoluteName text,    -- абсолютный путь к файлу на локальном диске
  pSize         integer, -- размер файла в байтах
  pHash         text,    -- SHA-256 хэш содержимого
  pMime         text     -- определённый MIME-тип
) RETURNS void ...
```

Типичный `done`-callback использует эту информацию для запуска следующего шага в пайплайне — например, вызывает `PutFileToS3` для загрузки скачанного файла в объектное хранилище.

Настройка
-
Включите модуль в конфигурационном файле Апостол:

```ini
[module/PGFile]
enable=true
```

Связанные модули
-
- **FileServer** — раздаёт файлы, управляемые PGFile, по HTTP (`GET /file/<uuid>/...`)
- **PGFetch** — необходим для загрузки в S3: `PutFileToS3` использует `http.fetch` для асинхронной отправки PUT-запроса на S3
- **Модуль `file` db-platform** — слой базы данных: таблица `db.file`, `api.get_file`, `PutFileToS3`, REST-эндпоинты, триггер `t_file_notify`
- **FileCommon** (`src/common/FileCommon`) — общий базовый C++-класс: аутентификация, очередь, `CFileHandler`, поддержка cURL

Установка
-
Следуйте указаниям по сборке и установке [Апостол](https://github.com/apostoldevel/apostol#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%B8-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0).

[^crm]: **Apostol CRM** — абстрактный термин, а не самостоятельный продукт. Он обозначает любой проект, в котором совместно используются фреймворк [Apostol](https://github.com/apostoldevel/apostol) (C++) и [db-platform](https://github.com/apostoldevel/db-platform) через специально разработанные модули и процессы. Каждый фреймворк можно использовать независимо; вместе они образуют полноценную backend-платформу.
